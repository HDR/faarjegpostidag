<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FÃ¥r Jeg Post I Dag?</title>
	<link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <style>
        body {
            background-color: black;
            overflow: hidden;
        }
        .child{
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 500px;
            color: #FFFFFF;
        }
        .bottom-right {
            position: absolute;
            bottom: 20px;
            right: 20px;
        }
    </style>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body>
<div class="child">
    <p id="JN"></p>
    <script>
        const params = new URLSearchParams(window.location.search);

        if(!params.has('zip')) {
            navigator.permissions.query({ name: 'geolocation' }).then( perm => {
                if(perm.state != 'granted'){
                    document.getElementById("JN").style.fontSize = "20%";
                    document.getElementById("JN").innerHTML = "Ingen tilgang til lokasjonsdata";
                } else {
                    document.getElementById("JN").style.fontSize = "100%";
                }
            })
        }
    </script>

    <script>

        let x = document.getElementById("JN").innerHTML;
        if(params.has('zip')) {
            x = params.get('zip');
            getPostalData(x);
            document.getElementById("JN").innerHTML = x;
        } else if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);
        } else {
            x = "Vet Ikke";
        }


        function showPosition(position) {
            let lat = position.coords.latitude;
            let long = position.coords.longitude;
            let url = "https://secure.geonames.org/findNearbyPostalCodesJSON?lat=" + lat + "&lng=" +  long + "&username=theaccount"
            $.getJSON(url, function(data) {
                if(data.postalCodes.length > 0 && data.postalCodes[0].countryCode == "NO") {
                    x = data.postalCodes[0].postalCode;
                    getPostalData(x);
                    document.getElementById("JN").innerHTML = x;
                } else {
                    x = "Vet Ikke";
                    document.getElementById("JN").innerHTML = x;
                }
            });
        }
        
        function getKey() {

            $.ajax({
                dataType: "html",
                url: "https://api.cors-hdr.workers.dev?https://www.posten.no/levering-av-post",
                success: function(data) {
                    let fetchraw = $(data).filter(function(){return $(this).attr('data-react4xp-ref') === 'parts_mailbox-delivery__main_1_leftRegion_11'})[0]
                    const apiKey = JSON.parse(fetchraw.innerText).props.apiKey;
                    return apiKey;
                }
            });
        }
        
        function getPostalData(zipCode) {
        
            let apiKey;
            $.ajax({
                dataType: "html",
                url: "https://api.cors-hdr.workers.dev?https://www.posten.no/levering-av-post",
                success: function(data) {
                    let fetchraw = $(data).filter(function(){return $(this).attr('data-react4xp-ref') === 'parts_mailbox-delivery__main_1_leftRegion_11'})[0]
                    apiKey = JSON.parse(fetchraw.innerText).props.apiKey;
                    $.ajax({
                        headers: {
                            'kp-api-token': apiKey,
                        },
                        dataType: "json",
                        url: "https://api.cors-hdr.workers.dev?https://www.posten.no/levering-av-post/_/service/no.posten.website/delivery-days?postalCode=" + zipCode,
                        success: function(data) {
                            if(data.delivery_dates[0].slice(-2) === new Intl.DateTimeFormat('en-us', {day: '2-digit'}).format(new Date)) {
                                x = "Ja";
                            } else {
                                x = "Nei";
                            }
                            document.getElementById("JN").innerHTML = x;
                            console.log("apiKey: " + apiKey)
                        }
                    });
                }
            });
        }

    </script>
</div>

<a href="https://twitter.com/MartinRefseth"><img class="bottom-right" alt="Twitter" src="assets/2021 Twitter logo - white.png" height=5%></a>

</body>
</html>